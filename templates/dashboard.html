<!DOCTYPE html>
<html>
<head>
    <title>Dashboard</title>
    <link rel="stylesheet" href="{{ url_for('static', filename='style.css') }}">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.0/css/all.min.css">
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
</head>

<body>

<div class="layout">

    <!-- SIDEBAR -->
    <div class="sidebar" id="sidebar">
        <div class="sidebar-header">
            <h2 class="logo">₹ Expense</h2>
            <button class="collapse-btn" onclick="toggleSidebar()">
                <i class="fas fa-bars"></i>
            </button>
        </div>

        <button class="nav-btn active" onclick="openTab(event,'dashboard')">
            <i class="fas fa-chart-pie"></i>
            <span>Dashboard</span>
        </button>

        <button class="nav-btn" onclick="openTab(event,'add')">
            <i class="fas fa-plus-circle"></i>
            <span>Add Expense</span>
        </button>

        <button class="nav-btn" onclick="openTab(event,'history')">
            <i class="fas fa-clock"></i>
            <span>History</span>
        </button>

        <button onclick="toggleTheme()" class="nav-btn">
            <i class="fas fa-moon"></i>
            <span>Toggle Theme</span>
        </button>

        <a href="/logout" class="logout-link">
            <i class="fas fa-sign-out-alt"></i>
            <span>Logout</span>
        </a>
    </div>

    <!-- MAIN CONTENT -->
    <div class="main-content">

        <!-- DASHBOARD TAB -->
        <div id="dashboard" class="tab-content active">

            <h2>Overview</h2>

            <div class="cards">
                <div class="card">
                    <h3>Total Expense</h3>
                    <p>₹{{ total }}</p>
                </div>

                <div class="card">
                    <h3>This Month</h3>
                    <p>₹{{ month_total }}</p>
                </div>

                <div class="card">
                    <h3>Last Month</h3>
                    <p>₹{{ last_month_total }}</p>
                </div>

                <div class="card">
                    <h3>Change</h3>
                    <p>{{ percent_change }}%</p>
                </div>
            </div>

            <div class="card" style="margin-top:20px;">
                <h3>Monthly Budget</h3>

                <form action="/set_budget" method="POST">
                    <input type="number" name="budget" placeholder="Set Monthly Budget" required>
                    <button type="submit">Save</button>
                </form>

                {% if budget > 0 %}
                    <p>Budget: ₹{{ budget }}</p>
                    <p>Used: {{ budget_percent }}%</p>

                    <div style="background:#ddd;height:20px;border-radius:10px;">
                        <div style="width: {{ budget_percent }}%; height:20px; border-radius:10px; background:green;">
                        </div>
                    </div>
                {% endif %}
            </div>

            <div class="card" style="margin-top:20px;">
                <h3>AI Financial Insights</h3>
                <ul>
                    {% for tip in insights %}
                        <li>{{ tip }}</li>
                    {% endfor %}
                </ul>
            </div>

            <div class="card" style="margin-top:20px;">
                <a href="/download_pdf">
                    <button>Download PDF Report</button>
                </a>
            </div>

            <!-- CHART -->
            <div class="card" style="margin-top:20px;">
                <h3>Category Breakdown</h3>
                <canvas id="expenseChart"></canvas>
            </div>

        </div>

        <!-- ADD TAB -->
        <div id="add" class="tab-content">
            <h2>Add Expense</h2>

            <div class="form-card">
                <form method="POST" action="/add">
                    <input type="text" name="name" placeholder="Expense Name" required>
                    <input type="number" name="amount" placeholder="Amount" required>
                    <button type="submit">Add Expense</button>
                </form>

                <hr>
                <hr>

<h3>Upload Receipt</h3>

<form action="/upload_receipt" method="POST" enctype="multipart/form-data">
    <input type="file" name="receipt" accept="image/*" required>
    <button type="submit">Upload & Auto Add</button>
</form>

                <h3>Smart Expense Assistant</h3>

                <div class="chat-box" id="chat-box">
                    <div class="bot-message">Try: <b>Add 200 groceries</b></div>
                </div>

                <input type="text" id="chat-input" placeholder="Type: Add 500 shopping...">
                <button onclick="sendMessage()">Send</button>
            </div>
        </div>

        <!-- HISTORY TAB -->
        <div id="history" class="tab-content">
            <h2>Expense History</h2>

            <table class="expense-table">
                <tr>
                    <th>Name</th>
                    <th>Category</th>
                    <th>Amount</th>
                    <th>Action</th>
                </tr>

                {% for e in expenses %}
                <tr>
                    <td>{{ e["description"] }}</td>
                    <td>{{ e["category"] }}</td>
                    <td>₹{{ e["amount"] }}</td>
                    <td>
                        <a class="delete-btn" href="/delete/{{ e['id'] }}">Delete</a>
                    </td>
                </tr>
                {% endfor %}
            </table>
        </div>

    </div>
</div>

<!-- TAB SCRIPT -->
<script>
function openTab(evt, tabId) {
    document.querySelectorAll('.tab-content').forEach(t => t.classList.remove('active'));
    document.querySelectorAll('.nav-btn').forEach(b => b.classList.remove('active'));
    document.getElementById(tabId).classList.add('active');
    evt.currentTarget.classList.add('active');
}
</script>

<script type="application/json" id="chart-data">
    {{ category_totals | tojson }}
</script>

<!-- CHART SCRIPT -->
<script>
document.addEventListener("DOMContentLoaded", function() {

    const chartElement = document.getElementById("expenseChart");
    if (!chartElement) return;

    const rawData = document.getElementById("chart-data").textContent;
    const chartData = JSON.parse(rawData);

    if (!chartData || Object.keys(chartData).length === 0) return;

    new Chart(chartElement, {
        type: "doughnut",
        data: {
            labels: Object.keys(chartData),
            datasets: [{
                data: Object.values(chartData)
            }]
        }
    });

});
</script>

<!-- TOGGLE THEME SCRIPT -->
<script>
function toggleTheme() {
    document.body.classList.toggle("dark-mode");

    if (document.body.classList.contains("dark-mode")) {
        localStorage.setItem("theme", "dark");
    } else {
        localStorage.setItem("theme", "light");
    }
}

window.onload = function() {
    if (localStorage.getItem("theme") === "dark") {
        document.body.classList.add("dark-mode");
    }
}
</script>

</body>
</html>