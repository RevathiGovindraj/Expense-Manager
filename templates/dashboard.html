<!DOCTYPE html>
<html>
<head>
    <title>Dashboard</title>
    <link rel="stylesheet" href="{{ url_for('static', filename='style.css') }}">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.0/css/all.min.css">
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
</head>

<body>

<div class="layout">

    <div class="sidebar" id="sidebar">

        <div class="sidebar-header">
            <h2 class="logo">₹ Expense</h2>
            <button class="collapse-btn" onclick="toggleSidebar()">
                <i class="fas fa-bars"></i>
            </button>
        </div>

        <button class="nav-btn active" onclick="openTab(event,'dashboard')">
            <i class="fas fa-chart-pie"></i>
            <span>Dashboard</span>
        </button>

        <button class="nav-btn" onclick="openTab(event,'add')">
            <i class="fas fa-plus-circle"></i>
            <span>Add Expense</span>
        </button>

        <button class="nav-btn" onclick="openTab(event,'history')">
            <i class="fas fa-clock"></i>
            <span>History</span>
        </button>

        <a href="/logout" class="logout-link">
            <i class="fas fa-sign-out-alt"></i>
            <span>Logout</span>
        </a>
    </div>

    <div class="main-content">

        <div id="dashboard" class="tab-content active">
            <h2>Overview</h2>

            <div class="cards">
                <div class="card">
                    <h3>Total Expense</h3>
                    <p>₹{{ total }}</p>
                </div>
                <div class="card">
                    <h3>Total Entries</h3>
                    <p>{{ expenses | length }}</p>
                </div>
            </div>

            <div class="chart-box">
                <canvas id="expenseChart"></canvas>
            </div>
        </div>

        <div id="add" class="tab-content">
            <h2>Add Expense</h2>

            <div class="form-card">
                <form method="POST" action="/add">
                    <input type="text" name="name" placeholder="Expense Name" required>
                    <input type="number" name="amount" placeholder="Amount" required>
                    <button type="submit">Add Expense</button>
                </form>

                <hr>

                <h3><i class="fas fa-chart-line"></i> Smart Expense Assistant</h3>

                <div class="chat-box" id="chat-box">
                    <div class="bot-message">Try: <b>Add 200 groceries</b></div>
                </div>

                <input type="text" id="chat-input" placeholder="Type: Add 500 shopping...">
                <button class="chat-send-btn" onclick="sendMessage()">Send</button>
            </div>
        </div>

        <div id="history" class="tab-content">
            <h2>Expense History</h2>

            <table class="expense-table">
                <tr>
                    <th>Name</th>
                    <th>Category</th>
                    <th>Amount</th>
                    <th>Action</th>
                </tr>

                {% for e in expenses %}
                <tr>
                    <td>{{ e["description"] }}</td>
                    <td>{{ e["category"] }}</td>
                    <td>₹{{ e["amount"] }}</td>
                    <td><a class="delete-btn" href="/delete/{{ e['id'] }}">Delete</a></td>
                </tr>
                {% endfor %}
            </table>
        </div>

    </div>
</div>

<script>
function openTab(evt, tabId) {
    document.querySelectorAll('.tab-content').forEach(t => t.classList.remove('active'));
    document.querySelectorAll('.nav-btn').forEach(b => b.classList.remove('active'));
    document.getElementById(tabId).classList.add('active');
    evt.currentTarget.classList.add('active');
}

function toggleSidebar() {
    document.getElementById("sidebar").classList.toggle("collapsed");
}

function sendMessage() {
    const input = document.getElementById("chat-input");
    const message = input.value.trim();
    if (!message) return;

    const chatBox = document.getElementById("chat-box");
    chatBox.innerHTML += `<div class="user-message">${message}</div>`;

    fetch("/chat_add", {
        method: "POST",
        headers: {"Content-Type": "application/x-www-form-urlencoded"},
        body: "message=" + encodeURIComponent(message)
    })
    .then(response => response.text())
    .then(data => {
        chatBox.innerHTML += `<div class="bot-message">${data}</div>`;
        chatBox.scrollTop = chatBox.scrollHeight;
    });

    input.value = "";
}
</script>

<script type="application/json" id="chart-data">
  {{ category_totals | tojson }}
</script>

<script>
const ctx = document.getElementById('expenseChart').getContext('2d');
const data = JSON.parse(document.getElementById('chart-data').textContent);

new Chart(ctx, {
  type: 'doughnut',
  data: {
    labels: Object.keys(data),
    datasets: [{
      data: Object.values(data)
    }]
  }
});
</script>

</body>
</html>
